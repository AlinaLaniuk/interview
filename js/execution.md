# Что такое Call Stack?

*по лекции Мурыча https://www.youtube.com/watch?v=CE0BhheYFQk&t=24s

Термина call stack в спецификации ecma не существует.

Call stack - это термин и часть архитектуры процессора х86. С помощью это структуры выполняются команды, поступающие процессору. И это происходит на уровне железа. Детали реализации сейчас значения не имеют.

То, как в js вызываются функции, похожу на то, как работает call stack. 

В спецификации ecma редакции 1997 года выполнение кода объеясняется следующим образом.
Чтобы код начал выполняться, он должен войти в контекст исполнения (execution context). Вместе с тем указывается, что существует некоторая структура, которая называется Execution Context Stack. 
Вот как это работает:

![image](https://github.com/AlinaLaniuk/interview/assets/101401177/8d3eec5f-1115-402b-8804-e75ee1aba399)


![image](https://github.com/AlinaLaniuk/interview/assets/101401177/f7e3da75-104e-4cfe-b6fc-dda9f116c4e8)

На уровне ассоциации: execution context stack существует для того, чтобы если в рамках функции происходил бы вызов другой функции, первая из них "помнила" бы, с какого места ей дальше нужно продолжать выполняться.


Но после того, как в js появилась возможность создавать несколько потоков, то есть фактически язык перестал быть однопоточным, все немного изменилось.

Сегодня хост-среда может иметь сколько угодно execution context stack. 
В спецификации закреплено такое понятие как кластер агентов, которые шарят между собой память.
Один агент может выполнять код для нескольких вкладок.

* перевод некоторых частей спеки

# 9 Исполнение кода и Контекст исполнения

Environment Record - это сущность спецификации, определяющая связи идентификаторов с конкретными переменными и функциями, основанная на лексической структуре вложенности js-кода. Чаще всего эта фущность связана с некоторыми синтаксическими структурами js-кода, такими как FunctionDeclaration, BlockStatement, Catch clause of a TryStatement. Каждый раз когда код выполняется, формируется новый Environment Record для связывания всех идентификаторов с конкретными значениями, указанных в этом коде.

Каждый Environment Record имеет поле [[OuterEnv]], которое либо ссылается на null, либо на внешний Environment Record. Используется это поле для формирования логической вложенности таких Environment Record. В этом поле будет храниться ссылка на внешнее окружение, которое логически окружает внутреннее Environment Record. При этом внешнее Environment Record может также содержать ссылку на свое внешнее Environment Record. При этом одно и то же внешнее Environment Record может быть у несколькоих внутренних Environment Record. К примеру, если внутри функции создаются две другие функции, они в качестве внешнего Environment Record будут иметь одну и ту же Environment Record "родительской" функции.

Environment Record - это исключительно механизм спецификации и этот термин никак не коррелирует с любыми артефактами имплементации ECMAScript. В рамках кода программно нельзя никак манипулировать этими понятиями.

**9.1 Иерархия Environment Record**

В качсетве аналогии на Environment Records можно рассматривать обычную объектно-ориентированную иерархию (думаю, здесь говорится о прототипном наследовании). Environment Record здесь - это абстрактный класс, от кторого "наследуют" три конкретных подкласса: Declarative Environment Record, Object Environment Record, and Global Environment Record. Еще два подкласса -  Function Environment Records and Module Environment Records  - это подклассы Declarative Environment Record.

- Declarative Environment Record - используется для определения "эффектов" от FunctionDeclarations, VariableDeclarations, and Catch clauses.
  Function Environment Record - используется при вызове функции и содержит привязки идентификаторов для этой функции. Может содержать this, а также необходимые сущности для вызова super.
  Module Environment Record - используется для работы модуля.  [[OuterEnv]] здесь будет содержать ссылку на Global Environment Record.

- Object Environment Record используется для определения WithStatement. Это легаси штука.

- Global Environment Record используется для связи глобальных идентификаторов скрипта. [[OuterEnv]]  указывает на null.

* https://tc39.es/ecma262/multipage/executable-code-and-execution-contexts.html#sec-environment-records - здесь можно посмотреть конкретику по каждому типу. В целом у Environment Record есть ряд внутренних методов и полей, которые наследуют другие records. Каждый из них в свою очередь имеет ряд собственных методов и полей.

**9.4 Execution Contexts**

Execution context - это механизм спецификации, который используется для трекинга исполнения кода рантаймом. В любой момент времени есть не более одного контекста исполнения кода для каждого агента. 

Execution context stack используется для трекинга контекстов выполнения. Текущий контекст исполнения всегда находится на вершине стека. Новый контекст исполнения пушится наверх стека и становится текущим контекстом исполнения.

Каждый контекст исполнения содержит по крайней мере те сущности, которые перечислены в таблице 25 https://tc39.es/ecma262/multipage/executable-code-and-execution-contexts.html#running-execution-context

Исполнение кода в рамках текущего контекста исполнения может быть приостановлено в различных точках согласно спецификации. После приостановки текущего контекста испонелнения другой контекст может стать текущим и выполнять свой код. Позже раннее приостановленный контекст исполнения может вновь стать текущим и продолжить свое выполнение. Как правило, работает это по принципу LIFO, но некоторые функции ECMAScript требуют другого порядка выполнения.






